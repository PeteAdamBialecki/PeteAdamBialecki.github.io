<!DOCTYPE html>
<html>

<head>
  <script src="d3.min.js" charset="utf-8"></script>
  <style>
    html {
      background: #777;
    }

    h1 {
      font-family: sans-serif;
      font-weight: lighter;
      font-size: 18px;      
    }
    
    h2 {
      font-family: sans-serif;
      font-weight: lighter;
      font-size: 14px;
    }

    .x-axis path, .y-axis path,
    .x-axis line, .y-axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }

    .x-axis text, .y-axis text {
      font-family: sans-serif;
      font-size: 10px;
    }
  </style>
</head>

<body>
  
  <p><h1>Choose Date Range:</h1>
    <select id="date-option">
      <option value="12">Last Year</option>
      <option value="6">Last 6/mo</option>
      <option value="3">Last Quarter</option>    
    </select>
  </p>
  
  
  <script>
    var h = 120;
    var w = 400;
    var padding = 25;
    
    function getDate(d) {

      var strDate = new String(d);
    
      var year = strDate.substr(0,4);
      var month = strDate.substr(4,2);
      var day = strDate.substr(6,2);
      
      return new Date(year, month, day);
    
    }

    function buildLine(ds) {
      
      var minDate = getDate(ds.monthlySales[0]['month'])
      var maxDate = getDate(ds.monthlySales[ds.monthlySales.length-1]['month']) 
      
      console.log("min: " + minDate);
      console.log("max: " + maxDate);

      var xScale = d3.time.scale()
        .domain([minDate, maxDate])
        .range([padding, w-padding])

      var yScale = d3.scale.linear()
        .domain([0, d3.max(ds.monthlySales, function(d) {
          return d.sales})])
        .range([h-padding, 10])

      var xAxisGen = d3.svg.axis().scale(xScale).orient("bottom").tickFormat(d3.time.format("%b"));
      var yAxisGen = d3.svg.axis().scale(yScale).orient("left").ticks(4);

      var lineFun = d3.svg.line()
        .x(function(d) {return xScale(getDate(d.month));})
        .y(function(d) {return yScale(d.sales);})
        .interpolate("linear");

      var svg = d3.select("body").append("svg").attr({
        width: w,
        height: h,
        "id": "svg-"+ds.category
      });

      var yaxis = svg.append("g").call(yAxisGen)
        .attr("class", "y-axis")
        .attr("transform", "translate(" + padding + ", 0)");

      var xAxis = svg.append("g").call(xAxisGen)
        .attr("class", "x-axis")
      .attr("transform", "translate(0," + (h-padding) + ")");
      
      var viz = svg.append("path")
        .attr({
          d: lineFun(ds.monthlySales),
          "stroke": "#222",
          "stroke-width": 2,
          "fill": "lightblue",
          "class": "path-" + ds.category
        })
    }

    function updateLine(ds) {
      
      var minDate = getDate(ds.monthlySales[0]['month'])
      var maxDate = getDate(ds.monthlySales[ds.monthlySales.length-1]['month']) 
      
      var xScale = d3.time.scale()
        .domain([minDate, maxDate])
        .range([padding, w-padding])

      var yScale = d3.scale.linear()
        .domain([0, d3.max(ds.monthlySales, function(d) {
          return d.sales})])
        .range([h-padding, 10])

      var xAxisGen = d3.svg.axis().scale(xScale)
        .orient("bottom")
        .tickFormat(d3.time.format("%b"));
      var yAxisGen = d3.svg.axis().scale(yScale)
        .orient("left")
        .ticks(4);

      var lineFun = d3.svg.line()
        .x(function(d) {return xScale(getDate(d.month));})
        .y(function(d) {return yScale(d.sales);})
        .interpolate("linear");

      var svg = d3.select("body").select("#svg-" + ds.category);

      var yaxis = svg.selectAll("g.y-axis").call(yAxisGen);

      var xAxis = svg.append("g.x-axis").call(xAxisGen);
      
      var viz = svg.append("path-" + ds.category)
        .attr({
          d: lineFun(ds.monthlySales),
        });
    }        
    
    function showHeader(ds) {
      d3.select("body").append("h2")
        .text(ds.category + " Sales 2018");
    }

    //    Global var for data:

    d3.json("https://api.github.com/repos/bsullins/d3js-resources/contents/monthlySalesbyCategoryMultiple.json", function(error, data) {
      if (error) {
        console.log(error);
      } else {
        console.log(data);
      }

      var decodedData = JSON.parse(window.atob(data.content));

      console.log(decodedData.contents[0]);

      decodedData.contents.forEach(function(ds) {
        console.log(ds);
        showHeader(ds);
        buildLine(ds);
      })

    });

  </script>
</body>

</html>